#!/usr/bin/env python3

# 1. to_zdsl.py --no-main --no-pre --no-post test_sabermul_nttmul_poly_invntt_tomont.gas 1> test_sabermul_nttmul_poly_invntt_tomont_preprocessed.cl
# 2. ./test_sabermul_nttmul_poly_invntt_tomont.py test_sabermul_nttmul_poly_invntt_tomont_preprocessed.cl > test_sabermul_nttmul_poly_invntt_tomont.cl

# Inputs:
# %rdx = 0x55555555f7c0
# L0x555555560700-L0x55555556071e (_16XP = 7681, num = 16)
# L0x555555560780-L0x55555556079e (_16XMONT_PINV = -9, num = 16)
# L0x5555555607a0-L0x5555555607be (_16XMONT = -3593 = 2^16 mod 7681, num = 16)
# L0x555555560800-L0x55555556093e (_ZETAS, num = 160)
# L0x555555560940-L0x555555560d3e (_TWIST32, num = 512)
# L0x555555560d40-L0x555555560dbe (_TWISTS4, num = 64)
# L0x7fffffffbb20-L0x7fffffffbd1e (input coefficients, num = 256)
# L0x7fffffffbb20-L0x7fffffffbd1e (output coefficients, num = 256)

import re, math
from argparse import ArgumentParser

ORIGINAL_N = 256
ORIGINAL_P = 8192
P = 7681
PINV = -7679   # p^-1 mod 2^16, -7679 * 7681 = 1 (mod 2^16)
MONT = -3593   # 2^16 mod p, -3593 = 4088 (mod 7681)
MONT_PINV = -9 # (MONT * p^-1) mod 2^16, -9*7681 = -3593 (mod 2^16)
ROOT = 62      # 62**256 = -1 (mod 7681)
# 2^(-16) mod 7681 = 900
_16XP_BASE = 0x555555560700
_16XP_NUM = 16
_16XMONT_PINV_BASE = 0x555555560780
_16XMONT_PINV_NUM = 16
_16XMONT_BASE = 0x5555555607a0
_16XMONT_NUM = 16
_ZETAS_BASE = 0x555555560800
_ZETAS_NUM = 160
_TWIST32_BASE = 0x555555560940
_TWIST32_NUM = 512
_TWISTS4_BASE = 0x555555560d40
_TWISTS4_NUM = 64
INPUT_BASE = 0x7fffffffbb20 # (L0x7fffffffbb20 ~ L0x7fffffffbd1e)
INPUT_NUM = 256
ANS_BASE = 0x7fffffffbb20 # (L0x7fffffffbb20 ~ L0x7fffffffbd1e)
ANS_NUM = 256
LEVEL3_TWIST = [62, 4236, 4600, 5805, 217, 7145, 738, 1115]
LEVEL7_TWIST = [1, 1213, 7154, 7098, 1366, 2648, 2132, 2446]
POLY_NAME = "inp_poly"
POLY_VAR = "x"

INIT_RANGES_7681 = [
    4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199, 4318, 4318, 4199, 4199
    ]

RANGES_7681 = [
    # Level 0
    [8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305, 8636, 8636, 8398, 4305],
    # Level 1
    [4439, 4439, 4439, 4439, 4439, 4536, 4782, 4407, 4439, 4251, 4767, 4051, 4439, 4554, 4636, 4301, 4439, 4101, 4390, 4322, 4439, 4271, 4450, 4269, 4439, 4322, 4111, 4154, 4439, 3861, 4785, 4271, 4439, 4439, 4439, 4439, 4439, 4536, 4782, 4407, 4439, 4251, 4767, 4051, 4439, 4554, 4636, 4301, 4439, 4101, 4390, 4322, 4439, 4271, 4450, 4269, 4439, 4322, 4111, 4154, 4439, 3861, 4785, 4271, 4439, 4439, 4439, 4439, 4439, 4536, 4782, 4407, 4439, 4251, 4767, 4051, 4439, 4554, 4636, 4301, 4439, 4101, 4390, 4322, 4439, 4271, 4450, 4269, 4439, 4322, 4111, 4154, 4439, 3861, 4785, 4271, 4439, 4439, 4439, 4439, 4439, 4536, 4782, 4407, 4439, 4251, 4767, 4051, 4439, 4554, 4636, 4301, 4439, 4101, 4390, 4322, 4439, 4271, 4450, 4269, 4439, 4322, 4111, 4154, 4439, 3861, 4785, 4271, 4439, 4439, 4439, 4439, 4439, 4536, 4782, 4407, 4439, 4251, 4767, 4051, 4439, 4554, 4636, 4301, 4439, 4101, 4390, 4322, 4439, 4271, 4450, 4269, 4439, 4322, 4111, 4154, 4439, 3861, 4785, 4271, 4439, 4439, 4439, 4439, 4439, 4536, 4782, 4407, 4439, 4251, 4767, 4051, 4439, 4554, 4636, 4301, 4439, 4101, 4390, 4322, 4439, 4271, 4450, 4269, 4439, 4322, 4111, 4154, 4439, 3861, 4785, 4271, 4439, 4439, 4439, 4439, 4439, 4536, 4782, 4407, 4439, 4251, 4767, 4051, 4439, 4554, 4636, 4301, 4439, 4101, 4390, 4322, 4439, 4271, 4450, 4269, 4439, 4322, 4111, 4154, 4439, 3861, 4785, 4271, 4439, 4439, 4439, 4439, 4439, 4536, 4782, 4407, 4439, 4251, 4767, 4051, 4439, 4554, 4636, 4301, 4439, 4101, 4390, 4322, 4439, 4271, 4450, 4269, 4439, 4322, 4111, 4154, 4439, 3861, 4785, 4271],
    # Level 2
    [8878, 8975, 9221, 8846, 8878, 8975, 9221, 8846, 8878, 8805, 9403, 8352, 4321, 4321, 4362, 4305, 8878, 8372, 8840, 8591, 4324, 4274, 4324, 4299, 8878, 8183, 8896, 8425, 4257, 4178, 4257, 4178, 8878, 8975, 9221, 8846, 8878, 8975, 9221, 8846, 8878, 8805, 9403, 8352, 4321, 4321, 4362, 4305, 8878, 8372, 8840, 8591, 4324, 4274, 4324, 4299, 8878, 8183, 8896, 8425, 4257, 4178, 4257, 4178, 8878, 8975, 9221, 8846, 8878, 8975, 9221, 8846, 8878, 8805, 9403, 8352, 4321, 4321, 4362, 4305, 8878, 8372, 8840, 8591, 4324, 4274, 4324, 4299, 8878, 8183, 8896, 8425, 4257, 4178, 4257, 4178, 8878, 8975, 9221, 8846, 8878, 8975, 9221, 8846, 8878, 8805, 9403, 8352, 4321, 4321, 4362, 4305, 8878, 8372, 8840, 8591, 4324, 4274, 4324, 4299, 8878, 8183, 8896, 8425, 4257, 4178, 4257, 4178, 8878, 8975, 9221, 8846, 8878, 8975, 9221, 8846, 8878, 8805, 9403, 8352, 4321, 4321, 4362, 4305, 8878, 8372, 8840, 8591, 4324, 4274, 4324, 4299, 8878, 8183, 8896, 8425, 4257, 4178, 4257, 4178, 8878, 8975, 9221, 8846, 8878, 8975, 9221, 8846, 8878, 8805, 9403, 8352, 4321, 4321, 4362, 4305, 8878, 8372, 8840, 8591, 4324, 4274, 4324, 4299, 8878, 8183, 8896, 8425, 4257, 4178, 4257, 4178, 8878, 8975, 9221, 8846, 8878, 8975, 9221, 8846, 8878, 8805, 9403, 8352, 4321, 4321, 4362, 4305, 8878, 8372, 8840, 8591, 4324, 4274, 4324, 4299, 8878, 8183, 8896, 8425, 4257, 4178, 4257, 4178, 8878, 8975, 9221, 8846, 8878, 8975, 9221, 8846, 8878, 8805, 9403, 8352, 4321, 4321, 4362, 4305, 8878, 8372, 8840, 8591, 4324, 4274, 4324, 4299, 8878, 8183, 8896, 8425, 4257, 4178, 4257, 4178],
    # Level 3
    [17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 16555, 17736, 17016, 8581, 8452, 8581, 8477, 4839, 4766, 4839, 4782, 4305, 4305, 4305, 4305, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 16555, 17736, 17016, 8581, 8452, 8581, 8477, 4839, 4766, 4839, 4782, 4305, 4305, 4305, 4305, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 16555, 17736, 17016, 8581, 8452, 8581, 8477, 4839, 4766, 4839, 4782, 4305, 4305, 4305, 4305, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 16555, 17736, 17016, 8581, 8452, 8581, 8477, 4839, 4766, 4839, 4782, 4305, 4305, 4305, 4305, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 16555, 17736, 17016, 8581, 8452, 8581, 8477, 4839, 4766, 4839, 4782, 4305, 4305, 4305, 4305, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 16555, 17736, 17016, 8581, 8452, 8581, 8477, 4839, 4766, 4839, 4782, 4305, 4305, 4305, 4305, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 16555, 17736, 17016, 8581, 8452, 8581, 8477, 4839, 4766, 4839, 4782, 4305, 4305, 4305, 4305, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 17780, 18624, 17198, 13199, 13296, 13583, 13151, 17756, 16555, 17736, 17016, 8581, 8452, 8581, 8477, 4839, 4766, 4839, 4782, 4305, 4305, 4305, 4305],
    # Level 4
    [4838, 4798, 4242, 4963, 4284, 4492, 4795, 5077, 4490, 4177, 4808, 4310, 4326, 3944, 4560, 4665, 4308, 4448, 3978, 4714, 4588, 4665, 4057, 4307, 4511, 4352, 5174, 3977, 3842, 3870, 3841, 4398, 4838, 4356, 4583, 4983, 4304, 4881, 4429, 4548, 4792, 4066, 5157, 4604, 4148, 4611, 4070, 4005, 4403, 4898, 4962, 3904, 4663, 4926, 4679, 4143, 4517, 5123, 5044, 4767, 4768, 4053, 4593, 3897, 4838, 4474, 4762, 4851, 4588, 4327, 3841, 4175, 4341, 5099, 4736, 3913, 4768, 4268, 4782, 4595, 4792, 4571, 4762, 4137, 4257, 4291, 3902, 4999, 4548, 4596, 5008, 3885, 4765, 3984, 4477, 4143, 4838, 5029, 4293, 4504, 5087, 4917, 4988, 4996, 4358, 4047, 4203, 4262, 4046, 4077, 4303, 4621, 4601, 4998, 4306, 4225, 3872, 4064, 4988, 4722, 4574, 4356, 4140, 4517, 4148, 4111, 4677, 4101, 4838, 4930, 4810, 4177, 4456, 4878, 3967, 4651, 4511, 3977, 3841, 5061, 4606, 3897, 4222, 4817, 4665, 4746, 4077, 4565, 5007, 4486, 4554, 3936, 4986, 4817, 4687, 5080, 3982, 4013, 4522, 3979, 4838, 4375, 4543, 4913, 3978, 4610, 4191, 4881, 4376, 4844, 5021, 4318, 3864, 4485, 4834, 4232, 4108, 4949, 4908, 5036, 4048, 4047, 4002, 3965, 4040, 5126, 4422, 4094, 4496, 4165, 4220, 4321, 4838, 5045, 4749, 4638, 3842, 4192, 4346, 4296, 4509, 4509, 5092, 4475, 3982, 4309, 4053, 4196, 4591, 4191, 4404, 4885, 5001, 4960, 4569, 5036, 4286, 4528, 5091, 4098, 3864, 4238, 4251, 4077, 4838, 3844, 4186, 5041, 5025, 4402, 4283, 4374, 4803, 4504, 4578, 4968, 4781, 4739, 4414, 4708, 3877, 3895, 5000, 4870, 3978, 4996, 4351, 4776, 4358, 4617, 4363, 4046, 4195, 4420, 4121, 4778],
    # Level 5
    [9676, 9154, 8825, 9946, 8588, 9373, 9224, 9625, 9282, 8243, 9965, 8914, 8474, 8555, 8630, 8670, 8711, 9346, 8940, 8618, 9251, 9591, 8736, 8450, 9028, 9475, 10218, 8744, 8610, 7923, 8434, 8295, 4143, 4142, 4112, 4158, 4111, 4142, 4142, 4142, 4142, 4111, 4158, 4127, 4111, 4111, 4111, 4112, 4112, 4142, 4127, 4111, 4142, 4142, 4112, 4111, 4127, 4142, 4173, 4112, 4111, 4096, 4111, 4111, 9676, 9503, 9055, 9355, 9675, 9244, 8829, 9171, 8699, 9146, 8939, 8175, 8814, 8345, 9085, 9216, 9393, 9569, 9068, 8362, 8129, 8355, 8890, 9721, 9122, 8952, 9148, 8402, 8913, 8095, 9154, 8244, 4178, 4178, 4143, 4178, 4178, 4178, 4143, 4169, 4143, 4169, 4143, 4143, 4143, 4143, 4151, 4178, 4178, 4178, 4151, 4143, 4125, 4143, 4143, 4178, 4160, 4143, 4169, 4143, 4143, 4125, 4169, 4143, 9676, 9305, 9353, 9090, 8434, 9488, 8158, 9532, 8887, 8821, 8862, 9379, 8470, 8382, 9056, 9049, 8773, 9695, 8985, 9601, 9055, 8533, 8556, 7901, 9026, 9943, 9109, 9174, 8478, 8178, 8742, 8300, 3995, 3982, 3982, 3982, 3978, 3982, 3965, 3982, 3978, 3978, 3978, 3982, 3978, 3978, 3982, 3982, 3978, 3995, 3982, 3995, 3982, 3978, 3978, 3965, 3982, 3995, 3982, 3982, 3978, 3965, 3978, 3978, 9676, 8889, 8935, 9679, 8867, 8594, 8629, 8670, 9312, 9013, 9670, 9443, 8763, 9048, 8467, 8904, 8468, 8086, 9404, 9755, 8979, 9956, 8920, 9812, 8644, 9145, 9454, 8144, 8059, 8658, 8372, 8855, 4364, 4323, 4323, 4364, 4323, 4296, 4323, 4323, 4337, 4323, 4364, 4337, 4323, 4323, 4296, 4323, 4296, 4269, 4337, 4364, 4323, 4391, 4323, 4364, 4323, 4337, 4337, 4269, 4269, 4323, 4296, 4323],
    # Level 6
    [19352, 18657, 17880, 19301, 18263, 18617, 18053, 18796, 17981, 17389, 18904, 17089, 17288, 16900, 17715, 17886, 18104, 18915, 18008, 16980, 17380, 17946, 17626, 18171, 18150, 18427, 19366, 17146, 17523, 16018, 17588, 16539, 8321, 8320, 8255, 8336, 8289, 8320, 8285, 8311, 8285, 8280, 8301, 8270, 8254, 8254, 8262, 8290, 8290, 8320, 8278, 8254, 8267, 8285, 8255, 8289, 8287, 8285, 8342, 8255, 8254, 8221, 8280, 8254, 4898, 4848, 4798, 4898, 4823, 4848, 4823, 4873, 4798, 4773, 4873, 4767, 4773, 4767, 4798, 4798, 4823, 4873, 4823, 4767, 4773, 4798, 4798, 4823, 4823, 4848, 4898, 4767, 4773, 4717, 4798, 4742, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 4274, 19352, 18194, 18288, 18769, 17301, 18082, 16787, 18202, 18199, 17834, 18532, 18822, 17233, 17430, 17523, 17953, 17241, 17781, 18389, 19356, 18034, 18489, 17476, 17713, 17670, 19088, 18563, 17318, 16537, 16836, 17114, 17155, 8359, 8305, 8305, 8346, 8301, 8278, 8288, 8305, 8315, 8301, 8342, 8319, 8301, 8301, 8278, 8305, 8274, 8264, 8319, 8359, 8305, 8369, 8301, 8329, 8305, 8332, 8319, 8251, 8247, 8288, 8274, 8301, 4711, 4711, 4711, 4711, 4636, 4711, 4636, 4711, 4711, 4636, 4711, 4711, 4636, 4636, 4636, 4711, 4636, 4636, 4711, 4711, 4711, 4711, 4636, 4636, 4636, 4711, 4711, 4636, 4636, 4636, 4636, 4636, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178, 4178],
    # Level 7
    [9676, 9277, 9277, 9676, 9277, 9277, 8878, 9277, 8878, 8878, 9676, 9277, 8878, 8878, 8878, 8878, 8878, 9277, 9277, 9277, 8878, 9277, 8878, 8878, 8878, 9676, 9676, 8878, 8878, 8878, 8878, 8878, 16680, 16625, 16560, 16682, 16590, 16598, 16573, 16616, 16600, 16581, 16643, 16589, 16555, 16555, 16540, 16595, 16564, 16584, 16597, 16613, 16572, 16654, 16556, 16618, 16592, 16617, 16661, 16506, 16501, 16509, 16554, 16555, 9609, 9559, 9509, 9609, 9459, 9559, 9459, 9584, 9509, 9409, 9584, 9478, 9409, 9403, 9434, 9509, 9459, 9509, 9534, 9478, 9484, 9509, 9434, 9459, 9459, 9559, 9609, 9403, 9409, 9353, 9434, 9378, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 8452, 4378, 4362, 4362, 4378, 4362, 4362, 4321, 4362, 4321, 4321, 4378, 4362, 4321, 4321, 4321, 4321, 4321, 4362, 4362, 4362, 4321, 4362, 4321, 4321, 4321, 4378, 4378, 4321, 4321, 4321, 4321, 4321, 4766, 4766, 4766, 4782, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4766, 4378, 4378, 4378, 4378, 4362, 4378, 4362, 4378, 4378, 4362, 4378, 4362, 4362, 4362, 4362, 4378, 4362, 4378, 4378, 4362, 4362, 4378, 4362, 4362, 4362, 4378, 4378, 4362, 4362, 4362, 4362, 4362, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305, 4305]
    ]

def join_chunks(xs, glue, n, indent=0):
    return [" " * indent + glue.join(xs[i:i + n]) for i in range(0, len(xs), n)]

def flatten(ll):
    return [i for l in ll for i in l]

def ziplist(l1, l2):
    return list(zip(l1, l2))

def num_to_bits (n, w):
    r = []
    for i in range (w):
        r.append (n % 2)
        n //= 2
    return (r)

def bits_to_num (l):
    r = 0
    for i in range (len(l) - 1, -1, -1):
        r = r * 2 + l[i]
    return (r)

def modP(n, p):
    n = n % p
    return n - p if n > p//2 else n

def ntt_mod(num_ans, prime, mont, root, negacyclic, stage):
    num_rings = 2**stage
    num_coeffs = num_ans // num_rings
    n_expn = int(math.log(num_ans, 2))
    num_bits = n_expn + 1 if negacyclic else n_expn
    res = []
    for i in range (num_rings):
        if negacyclic:
            l = num_to_bits(i, stage)
            l.reverse()
            l.insert(0, 1)
            l = [0 for i in range(num_bits - stage - 1)] + l
        else:
            l = num_to_bits(i, num_bits)
            l.reverse()
        e = bits_to_num(l)
        modulo = (root**e) % prime
        modulo_mont = (modulo * mont) % prime
        modulo = modulo - prime if modulo > prime / 2 else modulo
        modulo_mont = modulo_mont - prime if modulo_mont > prime / 2 else modulo_mont
        res.append(dict(modulo = modulo, mont = modulo_mont))
    return res

def get_ntt_mod_level3to7(i):
    if i < 2:
        return 1 if i % 2 == 0 else -1
    else:
        s = 0
        j = 0
        n = int(math.log(ORIGINAL_N, 2))
        for k in range(2, n + 1):
            if i < math.pow(2, k):
                s = k - 1
                break
        j = i % pow(2, s)
        return ntt_mod(num_ans=ANS_NUM, prime=P, mont=MONT, root=ROOT, negacyclic=True, stage=s)[j]["modulo"]
    return 0

def make_ymms(ymms, off, num):
    return ["ymm{}_{:x}".format(ymm, off + i) for ymm in ymms for i in range(num)]

def make_eqmod(poly_name, poly_mult, ymms, coefs, mods, mon_per_line=4):
    return "\n".join([
        "eqmod",
        "  {1}({0} * {0})".format(poly_name, "" if poly_mult == 1 else (str(poly_mult) + " * ")),
        "  (",
        " +\n".join(join_chunks(["{0}*({1}**{2})".format(ymms[i], coefs[i], i) for i in range(len(ymms))], " + ", mon_per_line, indent=4)),
        "  )",
        "  [{}]".format(", ".join(mods))
    ])

def str_range(args, left_rel, right_rel):
    return "  " + ",\n  ".join(join_chunks(["(-({1}))@16 {2} {0}, {0} {3} ({1})@16".format(ymm, r, left_rel, right_rel) for (ymm, r) in args], ", ", 2))

def print_comment(str):
    print("(* {} *)".format(str))

def str_ghost(typed_vars, easserts, rasserts):
    return "\n".join([
             "ghost {} :".format(", ".join(["{0}@{1}".format(var, typ) for (var, typ) in typed_vars])),
             "and [",
             "  {}".format("true" if len(easserts) == 0 else ",\n  ".join(easserts)),
             "] && and [",
             "  {}".format("true" if len(rasserts) == 0 else ",\n  ".join(rasserts)),
             "];"
           ])

def str_main_args ():
    return "\n".join([
        "(* parameters *)\n",
        ",\n".join(join_chunks(["sint16 f{:03d}".format(i) for i in range(INPUT_NUM)], ", ", 4))])

def str_precondition_algebra ():
    return "\n".join([
        "(* algebraic precondition *)\n",
        "true"])

def str_precondition_range ():
    return "\n".join([
        "(* range precondition *)\n",
        "and [",
        ",\n".join(join_chunks(["(-{0})@16 <s f{1:03d}, f{1:03d} <s {0}@16".format(INIT_RANGES_7681[i+off*128], i%8*16 + i//8 + off*128) for off in range(2) for i in range(128)], ", ", 4)),
        "]"])

def str_inits ():
    return "\n".join([
        "(* inits *)\n",
        "\n".join(join_chunks(["mov L0x{:x} f{:03d};".format(INPUT_BASE + 2 * i, i) for i in range(INPUT_NUM)], " ", 4))])

def str_twiddles ():
    _16XP = [ P, P, P, P, P, P, P, P, P, P, P, P, P, P, P, P ]
    _16XMONT_PINV = [
  MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV,
  MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV, MONT_PINV
        ]
    _16XMONT = [
  MONT, MONT, MONT, MONT, MONT, MONT, MONT, MONT,
  MONT, MONT, MONT, MONT, MONT, MONT, MONT, MONT
        ]
    _ZETAS = [
   28865,  28865,  28865,  28865,  28865,  28865,  28865,  28865,
   28865,  28865,  28865,  28865,  28865,  28865,  28865,  28865,
    3777,   3777,   3777,   3777,   3777,   3777,   3777,   3777,
    3777,   3777,   3777,   3777,   3777,   3777,   3777,   3777,
  -10350, -10350, -10350, -10350, -10350, -10350, -10350, -10350,
  -10350, -10350, -10350, -10350, -10350, -10350, -10350, -10350,
   -3182,  -3182,  -3182,  -3182,  -3182,  -3182,  -3182,  -3182,
   -3182,  -3182,  -3182,  -3182,  -3182,  -3182,  -3182,  -3182,
    4496,   4496,   4496,   4496,   4496,   4496,   4496,   4496,
   -7244,  -7244,  -7244,  -7244,  -7244,  -7244,  -7244,  -7244,
   -3696,  -3696,  -3696,  -3696,  -3696,  -3696,  -3696,  -3696,
   -1100,  -1100,  -1100,  -1100,  -1100,  -1100,  -1100,  -1100,
   16425,  16425,  16425,  16425,  16425,  16425,  16425,  16425,
   16425,  16425,  16425,  16425,  16425,  16425,  16425,  16425,
    3625,   3625,   3625,   3625,   3625,   3625,   3625,   3625,
    3625,   3625,   3625,   3625,   3625,   3625,   3625,   3625,
   14744,  14744,  14744,  14744,  14744,  14744,  14744,  14744,
   -4974,  -4974,  -4974,  -4974,  -4974,  -4974,  -4974,  -4974,
    2456,   2456,   2456,   2456,   2456,   2456,   2456,   2456,
    2194,   2194,   2194,   2194,   2194,   2194,   2194,   2194
        ]
    _TWIST32 = [
      -9,   -529,  32738,  -1851,     -9,  29394,  -7508, -20435,
      -9,  26288,   9855, -19215,     -9,  16006, -12611,   -964,
   -3593,    -17,  -1054,   3781,  -3593,   3794,   2732,  -2515,
   -3593,   1712,   2175,  -3343,  -3593,  -3450,  -2883,   1084,
   16279,  26288,  -8558,  -6297,  11783, -25648,  14351, -25733,
   21066, -23882, -17440,  -7304, -26279,  16791,  22124, -20435,
   -3689,   1712,  -1390,  -1689,      7,  -1072,  -1521,   1403,
    -438,  -2378,  -1056,  -3208,   1881,  -3177,   -404,  -2515,
    2816, -22039,   9855,  21168, -19394,  30255, -27132,  17013,
   23489, -18506,   1869,  10145,  -3114,   9650, -15358, -24232,
    2816,  -2071,   2175,  -3408,  -1986,  -2001,   3588,  -1931,
   -1599,   2998,   3405,   1441,   2006,    434,      2,  -3752,
    1724, -24214,   6032, -19215, -21467,  29453, -16655,  32124,
    4505,  13686, -25946, -12790, -23668, -31518,  14351,  12449,
    3772,   3434,  -2160,  -3343,    549,  -1779,   -783,   1404,
    -103,   2422,   3750,  -1526,   2956,    226,  -1521,   3745,
  -11655,  -1715,  24743,  26766,  23754,  22943,  -2722,   4880,
   18242,  26621, -32329, -10333, -22593, -16715,  30426,   2858,
     121,   -179,  -3417,   3214,   2250,  -1121,  -1698,  -3312,
     834,   3581,  -3145,  -3677,   2495,  -2891,    730,  -2262,
   21066,  -4624, -24573, -16186,  29667, -30597,  23225,  10333,
  -15998,   6510,  -3558,  17491,  11792,  30255,  -4693,  21723,
    -438,   3568,  -1533,  -2874,   3555,  -3461,   2233,   3677,
    -638,   -658,   -486,   -429,   3600,  -2001,  -2133,   -293,
  -20469, -23882,  26663,  14718,  -9488, -16885, -26220,  17636,
  -19351, -17082,   2722,   2807,  10972,  -5990,  29871,  -5299,
   -1525,  -2378,  -1497,   -642,  -1296,   2059,  -3692,   -796,
     617,  -3770,   1698,   -777,  -3364,  -2918,  -2385,  -3763,
   -4983,  18745, -17440, -32695,  -4505, -12261, -32252,  23933,
    2073, -30938,  30136,  16083, -21467, -32414,  -8908,   -947,
   -1399,  -2247,  -1056,   3657,    103,  -1509,  -1532,    893,
   -2535,  -1242,   1464,  -1837,    549,   -670,  -2764,    589,
      -9,  -1851,  -8558, -22039,     -9,   4573, -26441,  16791,
      -9,  -6297,   6032,  -4624,     -9,  -9513,   9360,  16006,
   -3593,   3781,  -1390,  -2071,  -3593,  -2083,   2743,  -3177,
   -3593,  -1689,  -2160,   3568,  -3593,   3287,   1168,  -3450,
    1724, -19215,  24743,  -4624, -21766,   1007, -15358, -25648,
   -4983,  -7304, -16092, -13711,  21399,   4573, -12611,  29394,
    3772,  -3343,  -3417,   3568,  -2310,   1519,      2,  -1072,
   -1399,  -3208,  -1756,   2161,   1431,  -2083,  -2883,   3794,
  -20469,  14718, -17440,  16638, -15307,  12449,  12269, -22764,
  -26382,  -5452, -25946, -11996,   5759,   -964, -26441,   9087,
   -1525,   -642,  -1056,   1278,  -1483,   3745,  -2579,   -236,
   -2830,    692,   3750,   2340,  -1921,   1084,   2743,   1407,
    5930, -23933, -16092, -18506,  11792, -28805, -27132,  -5990,
   -5913,  27243, -13933,   6510, -26279,  -6766,  -7508,  16791,
     810,   -893,  -1756,   2998,   3600,  -1669,   3588,  -2918,
   -1305,  -2965,    915,   -658,   1881,    402,   2732,  -3177,
  -18191, -15221, -26262,   2739,   -828, -15145,  -8908,  -9633,
   20315, -15111, -10478,    802, -20870,  -4565,  22124,  26783,
   -2319,   3723,   1386,   1203,  -2876,  -2345,  -2764,   -929,
   -1701,  -3335,  -3310,   -222,  -1414,  -2005,   -404,   2719,
    4505,  -5452,  -3456, -28958, -14121,  32124,  17602,   2526,
    2073,  22790, -24052,   9633, -21766, -20435,  21868,   3524,
    -103,    692,  -3456,   2786,  -1321,   1404,    194,   3550,
   -2535,   3334,   2572,    929,  -2310,  -2515,   -660,   1476,
    7491, -12790, -22875,  16885,  22568,  27858,  10478,  20119,
   31177,   5299, -21860, -10495,  -3114,   1007,   8472,   9650,
   -2237,  -1526,   -859,  -2059,   2088,   2258,   3310,    151,
    1993,   3763,  -3428,  -2815,   2006,   1519,  -3816,    434,
   -5913,  27636, -32329,  -2952,  29667,  23984, -10409,   8831,
  -11792,  14138,  13541,  31518,  11783,  30844, -15358, -19274,
   -1305,   1012,  -3145,   1144,   3555,   -592,   2391,   1151,
   -3600,    826,   2789,   -226,      7,    124,      2,   2230
        ]
    _TWISTS4 = [
      -9, -16425, -28865,  10350,  -3593,  -3625,  -3777,   3182,
      -9, -10350,  28865,  16425,  -3593,  -3182,   3777,   3625,
      -9,   4496, -10350,  14744,  -3593,  -3696,  -3182,   2456,
      -9,   4974, -16425,   7244,  -3593,  -2194,  -3625,   1100,
      -9, -11655,   4496, -18191,  -3593,    121,  -3696,  -2319,
      -9, -22593,   7244, -20315,  -3593,   2495,   1100,   1701,
      -9, -18191,  14744, -23754,  -3593,  -2319,   2456,  -2250,
      -9, -20870,   4974, -22593,  -3593,  -1414,  -2194,   2495
        ]
    twiddles = [
        ("_16XP", _16XP, _16XP_BASE),
        ("_16XMONT_PINV", _16XMONT_PINV, _16XMONT_PINV_BASE),
        ("_16XMONT", _16XMONT, _16XMONT_BASE),
        ("_ZETAS", _ZETAS, _ZETAS_BASE),
        ("_TWIST32", _TWIST32, _TWIST32_BASE),
        ("_TWISTS4", _TWISTS4, _TWISTS4_BASE)
        ]
    res = []
    for (name, arr, base) in twiddles:
        res.append("\n(* {} *)\n".format(name))
        res.append("\n".join(join_chunks(["mov L0x{:x} ({:4d})@sint16;".format(base + 2*i, arr[i]) for i in range (len(arr))], " ", 4)))
    return "\n".join(res)

def str_init_poly_var():
    return ("ghost {}@sint16 : true && true;").format(POLY_VAR)

def str_init_poly(off):
    return str_ghost([("{0}{1}".format(POLY_NAME, i + off*128), "sint16") for i in range(128)],
                     ["{0}{1} * {0}{1} = {2}".format(POLY_NAME, i + off*128, "L0x{:x}".format(INPUT_BASE + (i%8*16 + i//8 + off*128)*2)) for i in range(128)],
                     [])

def get_algebra(args, expn, mon_per_line=4):
    return [
        make_eqmod(poly_name, poly_mult, ymms, [POLY_VAR] * len(ymms),
                       [str(P), "{0} - ({1})".format(POLY_VAR, m) if expn == 1 else "{0}**{2} - ({1})".format(POLY_VAR, m, expn)],
                       mon_per_line) for (poly_name, poly_mult, ymms, m) in args
    ]

def str_algebra(args, expn, mon_per_line=4):
    return ",\n".join(get_algebra(args, expn, mon_per_line))

def str_assertions(pairs):
    equalities = []
    for (ymm1, ymm2) in pairs:
        for i in range(0, 16):
            equalities.append("mulLymm{0}_{2:x} = mulLymm{1}_{2:x}".format(ymm1, ymm2, i))
    return "assert true && and [\n{0}\n];\nassume and [\n{0}\n] && true;".format(",\n".join(join_chunks(equalities, ", ", 2)))

level = 0
off = 0
ecut_id = 0
rcut_id = 0
level5_ecut_ids = [[], []]
level6_ecut_ids = [[], []]
level6_off0_rcut_id = None

def print_instr(instr):
    global level, off, ecut_id, rcut_id, level5_ecut_ids, level6_ecut_ids, level6_off0_rcut_id

    # ========== Level 0 ==========
    if instr.startswith("(* vmovdqa 0x40(%rsi),%ymm6"):
        print_comment("===== Start of Level {}, off {} =====".format(level, off))
    elif instr.startswith("(* vpaddw %ymm5,%ymm4,%ymm14") and level == 0:
        print(str_assertions([(7, 12), (11, 13)]))
    elif instr.startswith("(* vpaddw %ymm6,%ymm14,%ymm4") and level == 0:
        print_comment("===== End of Level {}, off {} =====".format(level, off))
        # # Verified
        # print("assert")
        # print("and [")
        # print(str_algebra(
        #     args=[("{0}{1}".format(POLY_NAME, i + off*128),
        #            2**(level+1),
        #            make_ymms([[14, 5], [6, 7], [15, 9], [10, 11]][(i%8)//2], i//8, 1),
        #            get_ntt_mod_level3to7(i%4)) for i in range(128)],
        #     expn=1))
        # print("] && true;\n")
        #
        print("\n(* rcut {0} *)\n".format(rcut_id))
        print("rcut and [")
        print(str_range(
            ziplist(flatten([make_ymms([[14, 5], [6, 7], [15, 9], [10, 11]][i%4], i//4, 1) for i in range(64)]), RANGES_7681[level][(off*128):(off*128+128)]),
            "<=s",
            "<=s"))
        print("];\n")
        rcut_id = rcut_id + 1
        level = level + 1
        print_comment("===== Start of level {}, off {} =====".format(level, off))

    # ========== Level 1 ==========
    elif instr.startswith("(* vpsubw %ymm14,%ymm4,%ymm4") and level == 1:
        print(str_assertions([(4, 14)]))
    elif instr.startswith("(* vpsubw %ymm14,%ymm5,%ymm5") and level == 1:
        print(str_assertions([(5, 14)]))
    elif instr.startswith("(* vpsubw %ymm14,%ymm6,%ymm6") and level == 1:
        print(str_assertions([(6, 14)]))
    elif instr.startswith("(* vpsubw %ymm14,%ymm7,%ymm7") and level == 1:
        print(str_assertions([(7, 14)]))
    elif instr.startswith("(* vpsubw %ymm14,%ymm8,%ymm8") and level == 1:
        print(str_assertions([(8, 14)]))
    elif instr.startswith("(* vpsubw %ymm14,%ymm13,%ymm13") and level == 1:
        print(str_assertions([(13, 14)]))
    elif instr.startswith("(* vpsubw %ymm14,%ymm10,%ymm10") and level == 1:
        print(str_assertions([(10, 14)]))
    elif instr.startswith("(* vpsubw %ymm14,%ymm11,%ymm11") and level == 1:
        print(str_assertions([(11, 14)]))
    elif instr.startswith("(* vpsubw %ymm6,%ymm7,%ymm12") and level == 1:
        print_comment("===== End of Level {}, off {} =====".format(level, off))
        # # Verified
        # level1_algebras = str_algebra(
        #     args=[("{0}{1}".format(POLY_NAME, i + off*128),
        #                2**(level+1),
        #                make_ymms([[4], [5], [6], [7], [8], [13], [10], [11]][((i//4)%8)], i//32 * 4, 4),
        #                modP(LEVEL7_TWIST[(i//4)%8] * get_ntt_mod_level3to7(i%4), P)) for i in range(128)],
        #     expn=1)
        # print("assert")
        # print("and [")
        # print(level1_algebras)
        # print("] && true;\n")
        #
        print("\n(* rcut {0} *)\n".format(rcut_id))
        print("rcut and [")
        print(str_range(
            ziplist(flatten([make_ymms([[4], [5], [6], [7], [8], [13], [10], [11]][i%8], i//8 * 4, 4) for i in range(32)]), RANGES_7681[level][(off*128):(off*128+128)]),
            "<=s",
            "<=s"))
        print("];\n")
        rcut_id = rcut_id + 1
        level = level + 1
        print_comment("===== Start of level {}, off {} =====".format(level, off))

    # ========== Level 2 ==========
    elif instr.startswith("(* vpaddw %ymm5,%ymm4,%ymm15") and level == 2:
        print(str_assertions([(7, 12), (13, 9), (11, 14)]))
    elif instr.startswith("(* vpsubw %ymm8,%ymm10,%ymm12") and level == 2:
        print_comment("===== End of Level {}, off {} =====".format(level, off))
        # # Verified
        # level2_algebras = str_algebra(
        #     args=[("{0}{1}".format(POLY_NAME, i + off*128),
        #                2**(level+1),
        #                make_ymms([[15, 5], [6, 7], [8, 9], [10, 11]][((i//8)%4)], i//32 * 4, 4),
        #                modP(LEVEL7_TWIST[(i//4)%8] * get_ntt_mod_level3to7(i%4), P)) for i in range(128)],
        #     expn=1)
        # print("assert")
        # print("and [")
        # print(level2_algebras)
        # print("] && true;\n")
        #
        print("\n(* rcut {0} *)\n".format(rcut_id))
        print("rcut and [")
        print(str_range(
            ziplist(flatten([make_ymms([[15, 5], [6, 7], [8, 9], [10, 11]][i%4], i//4 * 4, 4) for i in range(16)]), RANGES_7681[level][(off*128):(off*128+128)]),
            "<=s",
            "<=s"))
        print("];\n")
        rcut_id = rcut_id + 1
        level = level + 1
        print_comment("===== Start of level {}, off {} =====".format(level, off))

    # ========== Level 3 ==========
    elif instr.startswith("(* vpaddw %ymm6,%ymm15,%ymm4") and level == 3:
        print(str_assertions([(10, 12), (11, 13)]))
    elif instr.startswith("(* vmovdqa 0x80(%rdx),%ymm13") and level == 3:
        print_comment("===== End of Level {}, off {} =====".format(level, off))
        # # Verified
        # level3_algebras = str_algebra(
        #     args=[("{0}{1}".format(POLY_NAME, i + off*128),
        #                2**(level+1),
        #                make_ymms([[4, 15, 6, 7], [8, 9, 10, 11]][((i//16)%2)], i//32 * 4, 4),
        #                modP(LEVEL7_TWIST[(i//4)%8] * get_ntt_mod_level3to7(i%4), P)) for i in range(128)],
        #     expn=1)
        # print("assert and [")
        # print(level3_algebras)
        # print("] && true;\n")
        #
        print("\n(* rcut {0} *)\n".format(rcut_id))
        print("rcut and [")
        print(str_range(
            ziplist(flatten([make_ymms([[4, 15, 6, 7], [8, 9, 10, 11]][i%2], i//2 * 4, 4) for i in range(8)]), RANGES_7681[level][(off*128):(off*128+128)]),
            "<=s",
            "<=s"))
        print("];\n")
        rcut_id = rcut_id + 1
        level = level + 1
        print_comment("===== Start of level {}, off {} =====".format(level, off))

    # ========== Level 4 ==========
    elif instr.startswith("(* vpsubw %ymm12,%ymm4,%ymm4") and level == 4:
        print(str_assertions([(4, 12)]))
    elif instr.startswith("(* vpsubw %ymm7,%ymm12,%ymm12") and level == 4:
        print(str_assertions([(12, 7)]))
    elif instr.startswith("(* vpsubw %ymm7,%ymm5,%ymm5") and level == 4:
        print(str_assertions([(5, 7)]))
    elif instr.startswith("(* vpsubw %ymm7,%ymm13,%ymm13") and level == 4:
        print(str_assertions([(13, 7)]))
    elif instr.startswith("(* vpsubw %ymm7,%ymm14,%ymm14") and level == 4:
        print(str_assertions([(14, 7)]))
    elif instr.startswith("(* vpsubw %ymm7,%ymm8,%ymm8") and level == 4:
        print(str_assertions([(8, 7)]))
    elif instr.startswith("(* vpsubw %ymm7,%ymm9,%ymm9") and level == 4:
        print(str_assertions([(9, 7)]))
    elif instr.startswith("(* vpsubw %ymm7,%ymm10,%ymm10") and level == 4:
        print(str_assertions([(10, 7)]))
    elif instr.startswith("(* vpsubw %ymm7,%ymm11,%ymm11") and level == 4:
        print(str_assertions([(11, 7)]))
    elif (instr.startswith("(* vpermq $0x4e,0x200(%rdx),%ymm2") or instr.startswith("(* vpermq $0x4e,0x180(%rdx),%ymm2")) and level == 4:
        print_comment("===== End of Level {}, off {} =====".format(level, off))
        # # Verified
        # level4_algebras = str_algebra(
        #     args=[("{0}{1}".format(POLY_NAME, i + off*128),
        #                2**(level+1),
        #                make_ymms([[3, 5, 7, 9], [4, 6, 8, 10]][((i//32)%2)], i//64 * 8, 8),
        #                modP(LEVEL3_TWIST[i//32 + off*4] * LEVEL7_TWIST[(i//4)%8] * get_ntt_mod_level3to7(i%4), P)) for i in range(128)],
        #     expn=1,
        #     mon_per_line=8)
        # print("assert and [")
        # print(level4_algebras)
        # print("] && true;\n")
        #
        print("\n(* rcut {0} *)\n".format(rcut_id))
        print("rcut and [")
        print(str_range(
            ziplist(flatten([make_ymms([[3, 5, 7, 9], [4, 6, 8, 10]][i%2], i//2 * 8, 8) for i in range(4)]), RANGES_7681[level][(off*128):(off*128+128)]),
            "<=s",
            "<=s"))
        print("];\n")
        rcut_id = rcut_id + 1
        level = level + 1
        print_comment("===== Start of level {}, off {} =====".format(level, off))

    # ========== Level 5 ==========
    elif instr.startswith("(* vpsubw %ymm4,%ymm12,%ymm4") and level == 5:
        print(str_assertions([(4, 12), (6, 13), (8, 14), (10, 15)]))
    elif (instr.startswith("(* vmovdqa 0x1c0(%rdx),%ymm2") or instr.startswith("(* vmovdqa 0x140(%rdx),%ymm2")) and level == 5:
        print_comment("===== End of Level {}, off {} =====".format(level, off))
        print("\n(* ecut {0}, rcut {1} *)\n".format(ecut_id, rcut_id))
        level5_summary_ecut_id = ecut_id
        level5_algebras = get_algebra(
            args=[("{0}{1}".format(POLY_NAME, i + off*128),
                       2**(level+1),
                       make_ymms([[11, 3, 7, 4], [5, 9, 6, 10]][i//64], 0, 16),
                       modP(LEVEL3_TWIST[i//32 + off*4] * LEVEL7_TWIST[(i//4)%8] * get_ntt_mod_level3to7(i%4), P)) for i in range(128)],
            expn=1,
            mon_per_line=16)
        print("cut and [")
        print(",\n".join(level5_algebras))
        print("] && and [")
        print(str_range(
            ziplist(flatten([make_ymms([[11, 3, 7, 4], [5, 9, 6, 10]][i], 0, 16) for i in range(2)]), RANGES_7681[level][(off*128):(off*128+128)]),
            "<=s",
            "<=s"))
        print("];\n")
        ecut_id = ecut_id + 1
        rcut_id = rcut_id + 1
        for i in range(128):
            print("\n(* ecut {0} *)\n".format(ecut_id))
            print("ecut")
            print(level5_algebras[i])
            print("prove with [cuts [{0}]];\n".format(level5_summary_ecut_id))
            level5_ecut_ids[off].append(ecut_id)
            ecut_id = ecut_id + 1
        level = level + 1
        print_comment("===== Start of level {}, off {} =====".format(level, off))

    # ========== Level 6 ==========
    elif instr.startswith("(* vpsubw %ymm5,%ymm12,%ymm5") and level == 6:
        print(str_assertions([(5, 12), (9, 13), (6, 14), (10, 15)]))
    elif instr.startswith("(* vpsubw %ymm13,%ymm11,%ymm11") and level == 6:
        print(str_assertions([(13, 11)]))
    elif instr.startswith("(* vpsubw %ymm13,%ymm3,%ymm3") and level == 6:
        print(str_assertions([(13, 3)]))
    elif (instr.startswith("(* vmovdqa 0x140(%rsi),%ymm6") or instr.startswith("(* vmovdqa (%rdi),%ymm4")) and level == 6:
        print_comment("===== End of Level {}, off {} =====".format(level, off))
        print("\n(* ecut {0}, rcut {1} *)\n".format(ecut_id, rcut_id))
        level6_summary_ecut_id = ecut_id
        if off == 0:
            level6_off0_rcut_id = rcut_id
        level6_algebras = get_algebra(
            args=[("{0}{1}".format(POLY_NAME, i + off*128),
                       2**(level+1),
                       ["L0x{:x}".format(ANS_BASE + 2 * (j + off*128)) for j in range(128)],
                       modP(LEVEL3_TWIST[i//32 + off*4] * LEVEL7_TWIST[(i//4)%8] * get_ntt_mod_level3to7(i%4), P)) for i in range(128)],
            expn=1,
            mon_per_line=32)
        print("cut")
        print(",\n".join(["{0} prove with [cuts [{1}]]".format(level6_algebras[i], level5_ecut_ids[off][i]) for i in range(128)]))
        print("&& and [")
        print(str_range(
            ziplist(["L0x{:x}".format(ANS_BASE + 2 * (j + off*128)) for j in range(128)], RANGES_7681[level][(off*128):(off*128+128)]),
            "<=s",
            "<=s"))
        print("];\n")
        ecut_id = ecut_id + 1
        rcut_id = rcut_id + 1
        for i in range(128):
            print("\n(* ecut {0} *)\n".format(ecut_id))
            print("ecut")
            print(level6_algebras[i])
            print("prove with [cuts [{0}]];\n".format(level6_summary_ecut_id))
            level6_ecut_ids[off].append(ecut_id)
            ecut_id = ecut_id + 1
        if off == 0:
            print("\n(* ecut {0}, rcut {1} *)\n".format(ecut_id, rcut_id))
            print("cut true && and [")
            print(",\n".join(join_chunks(["(-{0})@16 <s f{1:03d}, f{1:03d} <s {0}@16".format(INIT_RANGES_7681[i+128], i%8*16 + i//8 + 128) for i in range(128)], ", ", 4)))
            print("] prove with [precondition];\n")
            print(str_init_poly(off=1))
            ecut_id = ecut_id + 1
            rcut_id = rcut_id + 1
        (level, off) = (0, 1) if off == 0 else (7, 0)
        print_comment("===== Start of Level {}, off {} =====".format(level, off))

    # ========== Level 7 ==========
    elif instr.startswith("(* vpsubw %ymm8,%ymm12,%ymm8") and level == 7:
        print(str_assertions([(8, 12), (9, 13), (10, 14), (11, 15)]))
    elif (instr.startswith("(* vmovdqa 0x80(%rdi),%ymm4") or instr.startswith("(* #! <- SP = 0x7fffffff9a78 *)")) and level == 7:
        print_comment("===== End of Level {}, off {} =====".format(level, off))
        off = off + 1
        if off == 1:
            print_comment("===== Start of Level {}, off {} =====".format(level, off))
        elif off == 2:
            print("\n(* ecut {0}, rcut {1} *)\n".format(ecut_id, rcut_id))
            level7_algebras = get_algebra(
                args=[("{0}{1}".format(POLY_NAME, i + off*128),
                           2**(level+1),
                           ["L0x{:x}".format(ANS_BASE + 2 * j) for j in range(256)],
                           modP(LEVEL3_TWIST[i//32 + off*4] * LEVEL7_TWIST[(i//4)%8] * get_ntt_mod_level3to7(i%4), P)) for off in range(2) for i in range(128)],
                           expn=1,
                mon_per_line=64)
            print("ecut")
            print(",\n".join(["{0} prove with [cuts [{1}]]".format(level7_algebras[i+off*128], level6_ecut_ids[off][i]) for off in range(2) for i in range(128)]))
            print(";\n")
            ecut_id = ecut_id + 1

    print(instr)

def str_post():
    return "\n".join([
        "{",
        "true",
        "&&",
        "true",
        "}"
    ])

def main():
    parser = ArgumentParser()
    parser.add_argument("cl_file", help="the nttmul_poly_ntt cl file to be processed")
    args = parser.parse_args()
    with open(args.cl_file) as f:
        # ========== proc main ==========
        print('proc main(\n')
        print(str_main_args())
        print('\n) =\n')
        # ========== pre-condition ==========
        print('{\n')
        print(str_precondition_algebra())
        print("\n&&\n")
        print(str_precondition_range())
        print('\n}\n')
        # ========== inits ==========
        print(str_inits())
        print(str_twiddles())
        print()
        print(str_init_poly_var())
        print(str_init_poly(off=0))
        # ========== program ==========
        print("\n\n#===== program start =====\n\n")
        for line in f.readlines():
            print_instr(line.strip())
        # ========== post-condition ==========
        print(str_post())


if __name__ == "__main__":
  main()
